<!DOCTYPE html>
<html>
<body>

URL: <input type="text" id="url" value="https://developers.google.com">

<p>Click the button to fetch screenshot.</p>

<button onclick="run()">Fetch</button>
<div id="results"></div>

</body>
</html>
<script>
function run() {
  document.getElementById("results").innerHTML = 'Loading...';
  address = document.getElementById("url").value;
  const url = setUpQuery(address);
  fetch(url)
    .then(response => response.json())
    .then(json => {
      console.log(json);
      // See https://developers.google.com/speed/docs/insights/v5/reference/pagespeedapi/runpagespeed#response
      // to learn more about each of the properties in the response object.
      showInitialContent(json.id);
      const cruxMetrics = {
        "First Contentful Paint": json.loadingExperience.metrics.FIRST_CONTENTFUL_PAINT_MS.category,
        "First Input Delay": json.loadingExperience.metrics.FIRST_INPUT_DELAY_MS.category
      };
      showCruxContent(cruxMetrics);
      const lighthouse = json.lighthouseResult;
      const lighthouseMetrics = {
        'First Contentful Paint': lighthouse.audits['first-contentful-paint'].displayValue,
        'Speed Index': lighthouse.audits['speed-index'].displayValue,
        'Time To Interactive': lighthouse.audits['interactive'].displayValue,
        'First Meaningful Paint': lighthouse.audits['first-meaningful-paint'].displayValue,
        'First CPU Idle': lighthouse.audits['first-cpu-idle'].displayValue,
        'Estimated Input Latency': lighthouse.audits['estimated-input-latency'].displayValue
      };
      showLighthouseContent(lighthouseMetrics);
      showImage(lighthouse.audits['final-screenshot']);
    });
}

function setUpQuery(address) {
  const api = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed';
  const parameters = {
    url: encodeURIComponent(address),
    screenshot: true
  };
  let query = `${api}?`;
  first = true;
  for (key in parameters) {
    if (!first) {
      query += '&';
    }
    query += `${key}=${parameters[key]}`;
    first = false;
  }
  return query;
}

function showInitialContent(id) {
  document.getElementById("results").innerHTML = '';
  const title = document.createElement('h1');
  title.textContent = 'PageSpeed Insights API Demo';
  document.getElementById("results").appendChild(title);
  const page = document.createElement('p');
  page.textContent = `Page tested: ${id}`;
  document.getElementById("results").appendChild(page);
}

function showCruxContent(cruxMetrics) {
  const cruxHeader = document.createElement('h2');
  cruxHeader.textContent = "Chrome User Experience Report Results";
  document.getElementById("results").appendChild(cruxHeader);
  for (key in cruxMetrics) {
    const p = document.createElement('p');
    p.textContent = `${key}: ${cruxMetrics[key]}`;
    document.getElementById("results").appendChild(p);
  }
}

function showLighthouseContent(lighthouseMetrics) {
  const lighthouseHeader = document.createElement('h2');
  lighthouseHeader.textContent = "Lighthouse Results";
  document.getElementById("results").appendChild(lighthouseHeader);
  for (key in lighthouseMetrics) {
    const p = document.createElement('p');
    p.textContent = `${key}: ${lighthouseMetrics[key]}`;
    document.getElementById("results").appendChild(p);
  }
}

function showImage(screenshot) {
    var snap = screenshot.details.data;
    snap = snap.replace('_', '-').replace('/', '+');
    const img = document.createElement('img');
    img.src = snap;
    document.getElementById("results").appendChild(img);
}

</script>
